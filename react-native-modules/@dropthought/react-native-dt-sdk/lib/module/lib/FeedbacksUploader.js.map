{"version":3,"sources":["FeedbacksUploader.js"],"names":["isEmpty","uuidv4","apiPostEvent","QueueStorage","KEY_FEEDBACKS","KEY_FAILED_FEEDBACKS_DURING_PROCESSING","KEY_FAILED_REASONS_DURING_PROCESSING","FeedbacksQueue","key","encrypted","FailedFeedbacksQueue","FailedReasonsQueue","sendFeedback","surveyFeedback","console","log","programId","surveyId","feedbacks","metadata","createdTime","timeZone","UploaderStates","Idle","Processing","waitUntil","check","round","Promise","resolve","timeout","setTimeout","CreateFeedbacksUploader","initialized","state","numOfProcessed","userCanceled","subscriptions","publish","queuedFeedbacks","failedFeedbacksDuringProcessing","failedReasons","getAll","forEach","subscription","subscriber","uploadStatus","numOfFeedbacksProcessed","uploadSingle","feedback","front","err","enqueue","message","status","response","dequeue","uploadDone","length","retryFailed","failedFeedbacks","clear","uploadStart","uploadContinue","cancel","all","initialize","undefined","upload","subscribe","id","push","removeSubscription","filter","sub","feedbackUploader"],"mappings":"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","sourcesContent":["import { isEmpty } from 'ramda';\nimport uuidv4 from 'uuid/v4';\n\nimport { apiPostEvent } from './API';\n\nimport QueueStorage from './QueueStorage';\n\nconst KEY_FEEDBACKS = 'KEY_FEEDBACKS';\nconst KEY_FAILED_FEEDBACKS_DURING_PROCESSING =\n  'KEY_FAILED_FEEDBACKS_DURING_PROCESSING';\nconst KEY_FAILED_REASONS_DURING_PROCESSING =\n  'KEY_FAILED_REASONS_DURING_PROCESSING';\n\n/** @type {QueueStorage<SurveyFeedback>} */\nexport const FeedbacksQueue = new QueueStorage({\n  key: KEY_FEEDBACKS,\n  encrypted: true,\n});\n/** @type {QueueStorage<SurveyFeedback>} */\nexport const FailedFeedbacksQueue = new QueueStorage({\n  key: KEY_FAILED_FEEDBACKS_DURING_PROCESSING,\n  encrypted: true,\n});\n/** @type {QueueStorage<FailedReason>} */\nexport const FailedReasonsQueue = new QueueStorage({\n  key: KEY_FAILED_REASONS_DURING_PROCESSING,\n  encrypted: true,\n});\n\n/**\n * @param {SurveyFeedback} surveyFeedback\n * @param {*} cancelSource\n */\nasync function sendFeedback(surveyFeedback) {\n  console.log('[RN][sendFeedback] --------------');\n  console.log('[RN][sendFeedback] Send feedback: ', surveyFeedback);\n  console.log('[RN][sendFeedback] --------------');\n  return apiPostEvent({\n    programId: surveyFeedback.surveyId,\n    feedbacks: surveyFeedback.feedbacks,\n    metadata: surveyFeedback.metadata,\n    createdTime: surveyFeedback.createdTime,\n    timeZone: surveyFeedback.timeZone,\n  });\n}\n\n/** @enum {'idle' | 'processing' } */\nexport const UploaderStates = {\n  Idle: 'idle',\n  Processing: 'processing',\n};\n\n/**\n * @typedef {Object} FeedbackUploaderSubscription\n * @property {string} id\n * @property {FeedbackUploaderSubscriber} subscriber\n */\n/**\n * @typedef {Object} FeedbackUploaderPublishState\n * @property {UploaderStates} uploadStatus\n * @property {number} numOfFeedbacksProcessed\n * @property {SurveyFeedback[]} queuedFeedbacks\n * @property {SurveyFeedback[]} failedFeedbacksDuringProcessing\n * @property {FailedReason[]} failedReasons\n * @property {boolean} userCanceled\n */\n/**\n * @typedef {(state: FeedbackUploaderPublishState) => void} FeedbackUploaderSubscriber\n */\n\n/**\n * @param {() => boolean} check\n * @returns\n */\nconst waitUntil = async (check) => {\n  let round = 0;\n  return new Promise((resolve) => {\n    const timeout = () => {\n      round++;\n      setTimeout(() => {\n        if (check() || round >= 10) {\n          resolve();\n          return;\n        } else {\n          timeout();\n        }\n      }, 500);\n    };\n    timeout();\n  });\n};\n\nfunction CreateFeedbacksUploader() {\n  /** @type {boolean | null | undefined} */\n  let initialized = null; // null -> not start yet, undefined -> in progress, true -> finished\n  let state = UploaderStates.Idle;\n  let numOfProcessed = 0;\n  let userCanceled = false;\n\n  /** @type {FeedbackUploaderSubscription[]} */\n  let subscriptions = [];\n\n  function publish() {\n    if (isEmpty(subscriptions)) return;\n\n    const [queuedFeedbacks, failedFeedbacksDuringProcessing, failedReasons] = [\n      FeedbacksQueue.getAll(),\n      FailedFeedbacksQueue.getAll(),\n      FailedReasonsQueue.getAll(),\n    ];\n\n    subscriptions.forEach((subscription) => {\n      if (\n        subscription.subscriber &&\n        typeof subscription.subscriber === 'function'\n      ) {\n        subscription.subscriber({\n          uploadStatus: state,\n          numOfFeedbacksProcessed: numOfProcessed,\n          queuedFeedbacks,\n          failedFeedbacksDuringProcessing,\n          failedReasons,\n          userCanceled,\n        });\n      }\n    });\n  }\n\n  async function uploadSingle() {\n    // if user cancel, stop process the next feedback\n    if (userCanceled) {\n      return;\n    }\n\n    const feedback = FeedbacksQueue.front();\n\n    // no more feedback in the queue, stop\n    if (!feedback) return;\n\n    try {\n      await sendFeedback(feedback);\n      numOfProcessed++;\n    } catch (err) {\n      console.log('[RN][uploadSingle][catch] --------------');\n      console.log('[RN][uploadSingle][catch] Feedback: ', feedback);\n      console.log('[RN][uploadSingle][catch] Error: ', err);\n      // failed, add to failed queue\n      FailedFeedbacksQueue.enqueue(feedback);\n      FailedReasonsQueue.enqueue({\n        message: err.message,\n        status: err.response?.status,\n      });\n      console.log(\n        '[RN][uploadStart][catch] FailedFeedbacksQueue: ',\n        FailedFeedbacksQueue.getAll()\n      );\n      console.log('[RN][uploadSingle][catch] --------------');\n    } finally {\n      FeedbacksQueue.dequeue();\n\n      publish();\n      console.log('[RN][uploadSingle][finally] --------------');\n      console.log('[RN][uploadSingle][finally] Upload next');\n      console.log('[RN][uploadSingle][finally] --------------');\n      await uploadSingle();\n    }\n  }\n\n  function uploadDone() {\n    state = UploaderStates.Idle;\n    console.log('[RN][uploadDone] --------------');\n    console.log('[RN][uploadDone] Done for current upload proccess.');\n    console.log(\n      '[RN][uploadDone] Failed count: ',\n      FailedFeedbacksQueue.getAll()?.length\n    );\n    console.log('[RN][uploadDone] --------------');\n    publish();\n  }\n\n  function retryFailed() {\n    // get failed feedbacks and save to processing queue\n    // clear failed feedback queue\n    const failedFeedbacks = FailedFeedbacksQueue.getAll();\n    FeedbacksQueue.enqueue(failedFeedbacks);\n    FailedFeedbacksQueue.clear();\n    FailedReasonsQueue.clear();\n  }\n\n  function uploadStart() {\n    // reset states\n    state = UploaderStates.Processing;\n    numOfProcessed = 0;\n    userCanceled = false;\n\n    console.log('[RN][uploadStart] --------------');\n    console.log('[RN][uploadStart] FeedbacksQueue: ', FeedbacksQueue.getAll());\n    console.log(\n      '[RN][uploadStart] FailedFeedbacksQueue: ',\n      FailedFeedbacksQueue.getAll()\n    );\n    console.log(\n      '[RN][uploadStart] Copy FailedFeedbacksQueue to FeedbacksQueue'\n    );\n    retryFailed();\n\n    console.log('[RN][uploadStart] FeedbacksQueue: ', FeedbacksQueue.getAll());\n    console.log(\n      '[RN][uploadStart] FailedFeedbacksQueue: ',\n      FailedFeedbacksQueue.getAll()\n    );\n    console.log('[RN][uploadStart] --------------');\n\n    publish();\n  }\n\n  function uploadContinue() {\n    retryFailed();\n    publish();\n  }\n\n  /**\n   * @public\n   */\n  function cancel() {\n    userCanceled = true;\n    publish();\n  }\n\n  /**\n   * @public\n   */\n  async function clear() {\n    cancel();\n    await Promise.all([\n      FeedbacksQueue.clear(),\n      FailedFeedbacksQueue.clear(),\n      FailedReasonsQueue.clear(),\n    ]);\n  }\n\n  /**\n   * @public\n   */\n  async function initialize() {\n    // only initialize once\n    if (initialized === true) return;\n    if (typeof initialized === 'undefined') {\n      return waitUntil(() => initialized === true);\n    }\n    initialized = undefined;\n\n    // check queues are initialized\n    await Promise.all([\n      FeedbacksQueue.initialize(),\n      FailedFeedbacksQueue.initialize(),\n      FailedReasonsQueue.initialize(),\n    ]);\n    initialized = true;\n  }\n\n  /**\n   * @public\n   */\n  async function upload() {\n    if (initialized !== true) return;\n\n    if (state === UploaderStates.Processing) {\n      // upload is in process\n      uploadContinue();\n      return;\n    }\n\n    uploadStart();\n\n    // upload feedback one by one\n    await uploadSingle();\n\n    // all the feedbacks are processed\n    uploadDone();\n  }\n\n  /**\n   * @public\n   * @param {FeedbackUploaderSubscriber} subscriber\n   */\n  function subscribe(subscriber) {\n    const id = uuidv4();\n    const subscription = {\n      id,\n      subscriber,\n    };\n    subscriptions.push(subscription);\n    publish();\n    return function removeSubscription() {\n      subscriptions = subscriptions.filter((sub) => sub.id !== id);\n    };\n  }\n\n  return {\n    upload,\n    subscribe,\n    cancel,\n    clear,\n    initialize,\n  };\n}\n\n/**\n * @description singleton uploader\n * @example\n *     // to upload\n *     feedbackUploader.upload()\n *\n *     // to cancel\n *     feedbackUploader.cancel()\n *\n *     // to clear all the saved unsent feedbacks\n *     feedbackUploader.clear()\n *\n *     // to subscribe state\n *     const unSubscribe = feedbackUploader.subscribe( state => {\n *         console.log(state)\n *         // check type FeedbackUploaderPublishState\n *     })\n *     // to unsubscribe\n *     unSubscribe()\n */\nexport const feedbackUploader = CreateFeedbacksUploader();\n\n/**@typedef {import('../data').Feedback} Feedback */\n/**@typedef {import('../data').SurveyFeedback} SurveyFeedback */\n\n/**\n * @typedef {Object} FailedReason\n * @property {string} message\n * @property {number|undefined} status\n */\n"]}